============================eslint.config.js============================
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])

==========================================================================

============================postcss.config.js============================
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
==========================================================================

============================tailwind.config.js============================
import { heroui } from "@heroui/react";

/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
    "./node_modules/@heroui/theme/dist/**/*.{js,ts,jsx,tsx}"
  ],
  theme: {
    extend: {},
  },
  darkMode: "class",
  plugins: [heroui()],
}
==========================================================================

============================vite.config.ts============================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'path'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "./src"),
    },
  },
  server: {
    proxy: {
      // è¿™é‡Œçš„é…ç½®æ˜¯ä¸ºäº†è®©å‰ç«¯èƒ½è®¿é—® Python åç«¯ï¼Œè§£å†³è·¨åŸŸé—®é¢˜
      '/api': {
        target: 'http://127.0.0.1:8000', // Python æœåŠ¡çš„åœ°å€
        changeOrigin: true,
      }
    }
  }
})
==========================================================================

============================src/App.css============================
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}

==========================================================================

============================src/App.tsx============================
import { BrowserRouter, Routes, Route, Link } from 'react-router-dom';
import CaptchaDebugPage from '@/pages/CaptchaDebug';
import CaptchaWidget from '@/components/CaptchaWidget';
import { Button } from "@heroui/react";

function HomePage() {
    return (
        <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 dark:bg-gray-900">
            <div className="text-center mb-10">
                <h1 className="text-4xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-purple-600">
                    ChemCaptcha
                </h1>
                <p className="text-gray-500">åŸºäºåŒ–å­¦ç»“æ„çš„ä¸‹ä¸€ä»£å®‰å…¨éªŒè¯ç³»ç»Ÿ</p>
            </div>

            {/* æ¼”ç¤ºåŒºåŸŸ */}
            <div className="mb-10">
                <CaptchaWidget
                    width={400}
                    height={300}
                    onSuccess={() => alert("éªŒè¯é€šè¿‡ï¼")}
                />
            </div>

            <div className="flex gap-4">
                <Link to="/debug">
                    <Button color="secondary" variant="flat">
                        è¿›å…¥å¼€å‘è€…è°ƒè¯•æ¨¡å¼ (Debug)
                    </Button>
                </Link>
                <Button
                    as="a"
                    href="http://127.0.0.1:8000/docs"
                    target="_blank"
                    color="primary"
                    variant="ghost"
                >
                    åç«¯ API æ–‡æ¡£
                </Button>
            </div>

            <div className="mt-10 text-xs text-gray-400">
                Production Mode Preview
            </div>
        </div>
    );
}

function App() {
    return (
        <BrowserRouter>
            <Routes>
                <Route path="/" element={<HomePage />} />
                <Route path="/debug" element={<CaptchaDebugPage />} />
            </Routes>
        </BrowserRouter>
    )
}

export default App
==========================================================================

============================src/index.css============================
@tailwind base;
@tailwind components;
@tailwind utilities;
==========================================================================

============================src/main.tsx============================
import React from 'react'
import ReactDOM from 'react-dom/client'
import { HeroUIProvider } from '@heroui/react'
import App from './App.tsx'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
    <React.StrictMode>
        <HeroUIProvider>
            <App />
        </HeroUIProvider>
    </React.StrictMode>,
)
==========================================================================

============================src/components/CaptchaWidget.tsx============================
import { useState, useEffect, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Card, CardBody, CardFooter, Button, Spinner } from '@heroui/react';
import clsx from 'clsx';

interface CaptchaProps {
    slug?: string;
    width?: number;
    height?: number;
    onSuccess?: () => void;
    className?: string;
}

interface Point {
    x: number;
    y: number;
}

export default function CaptchaWidget({
                                          slug,
                                          width = 400,
                                          height = 300,
                                          onSuccess,
                                          className
                                      }: CaptchaProps) {
    const [loading, setLoading] = useState(true);
    const [captchaData, setCaptchaData] = useState<any>(null);
    const [clicks, setClicks] = useState<Point[]>([]);
    const [verifyStatus, setVerifyStatus] = useState<'idle' | 'verifying' | 'success' | 'fail'>('idle');
    const [message, setMessage] = useState('');

    const imgRef = useRef<HTMLImageElement>(null);

    // è·å–éªŒè¯ç 
    const fetchCaptcha = async () => {
        setLoading(true);
        setClicks([]);
        setVerifyStatus('idle');
        setMessage('');

        try {
            const url = slug
                ? `/api/captcha/${slug}/generate?width=${width}&height=${height}`
                : `/api/captcha/random?width=${width}&height=${height}`; // ç”Ÿäº§æ¨¡å¼

            const res = await fetch(url);
            const data = await res.json();
            setCaptchaData(data);
        } catch (e) {
            setMessage("ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½éªŒè¯ç ");
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchCaptcha();
    }, [slug]);

    // å¤„ç†å›¾ç‰‡ç‚¹å‡»
    const handleImageClick = (e: React.MouseEvent<HTMLImageElement>) => {
        if (verifyStatus === 'success' || verifyStatus === 'verifying') return;

        const rect = e.currentTarget.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // æ·»åŠ ç‚¹å‡»æ ‡è®°
        setClicks(prev => [...prev, { x, y }]);
    };

    // æ’¤é”€ä¸Šä¸€æ­¥
    const undo = () => setClicks(prev => prev.slice(0, -1));

    // æäº¤éªŒè¯
    const verify = async () => {
        if (!captchaData) return;
        setVerifyStatus('verifying');

        // æ„é€ åŠ å¯† Payload (åç«¯ Security.py éœ€è¦ token å’Œ user_input)
        // æ³¨æ„ï¼šè¿™é‡Œä¸ç”¨åŠ å¯†æ•´ä¸ª Bodyï¼Œå› ä¸ºåç«¯æ¥å£å®šä¹‰æ˜¯æ¥æ”¶ JSONã€‚
        // æˆ‘ä»¬éœ€è¦åœ¨ Body é‡Œä¼  token (å·²åŠ å¯†) å’Œ user_inputã€‚
        // å¦‚æœä½ è¦å…¨åŠ å¯† Bodyï¼Œåç«¯ router éœ€è¦æ”¹ã€‚
        // è¿™é‡ŒæŒ‰ç…§ä½ ä¹‹å‰ç»™çš„ Python Pydantic Schema:
        // class CaptchaVerifyRequest(BaseModel):
        //    token: str
        //    user_input: List[Point]

        const payload = {
            token: captchaData.token, // è¿™æ˜¯åç«¯å‘æ¥çš„å·²åŠ å¯† token
            user_input: clicks
        };

        // å…·ä½“çš„ API è°ƒç”¨
        const verifyUrl = slug
            ? `/api/captcha/${slug}/verify`
            : `/api/captcha/verify`;

        try {
            const res = await fetch(verifyUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await res.json();

            if (result.success) {
                setVerifyStatus('success');
                setMessage("éªŒè¯é€šè¿‡ï¼æ­£åœ¨è·³è½¬...");
                setTimeout(() => onSuccess && onSuccess(), 1000);
            } else {
                setVerifyStatus('fail');
                setMessage("éªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•");
                setTimeout(() => {
                    setVerifyStatus('idle');
                    setClicks([]); // å¤±è´¥æ¸…ç©ºç‚¹å‡»
                }, 1500);
            }
        } catch (e) {
            setVerifyStatus('fail');
            setMessage("ç³»ç»Ÿå¼‚å¸¸");
        }
    };

    return (
        <Card className={clsx("backdrop-blur-md bg-white/70 dark:bg-black/60 border-white/20 shadow-xl", className)}>
            <CardBody className="flex flex-col items-center p-4">
                {/* æç¤ºæ–‡å­— */}
                <div className="mb-2 text-sm font-semibold text-gray-700 dark:text-gray-200">
                    {captchaData ? captchaData.prompt : "æ­£åœ¨åŠ è½½å®‰å…¨éªŒè¯..."}
                </div>

                {/* å›¾ç‰‡åŒºåŸŸ */}
                <div
                    className="relative rounded-lg overflow-hidden border-2 border-dashed border-gray-300 dark:border-gray-600 transition-colors"
                    style={{ width: width, height: height }}
                >
                    {loading ? (
                        <div className="absolute inset-0 flex items-center justify-center bg-gray-100/50">
                            <Spinner size="lg" />
                        </div>
                    ) : (
                        <>
                            {/* éªŒè¯ç å›¾ç‰‡ */}
                            <img
                                ref={imgRef}
                                src={`data:image/png;base64,${captchaData?.img_base64}`}
                                alt="captcha"
                                className="w-full h-full object-contain cursor-crosshair select-none"
                                onClick={handleImageClick}
                                draggable={false}
                            />

                            {/* ç‚¹å‡»æ ‡è®°åŠ¨ç”» */}
                            <AnimatePresence>
                                {clicks.map((p, i) => (
                                    <motion.div
                                        key={i}
                                        initial={{ scale: 0, opacity: 0 }}
                                        animate={{ scale: 1, opacity: 1 }}
                                        exit={{ scale: 0, opacity: 0 }}
                                        className="absolute w-4 h-4 -ml-2 -mt-2 rounded-full bg-primary border-2 border-white shadow-sm pointer-events-none z-10"
                                        style={{ left: p.x, top: p.y }}
                                    />
                                ))}
                            </AnimatePresence>

                            {/* çŠ¶æ€é®ç½© */}
                            {verifyStatus === 'success' && (
                                <motion.div
                                    initial={{ opacity: 0 }} animate={{ opacity: 1 }}
                                    className="absolute inset-0 bg-green-500/30 flex items-center justify-center backdrop-blur-sm"
                                >
                                    <span className="text-4xl">âœ…</span>
                                </motion.div>
                            )}
                            {verifyStatus === 'fail' && (
                                <motion.div
                                    initial={{ opacity: 0 }} animate={{ opacity: 1 }}
                                    className="absolute inset-0 bg-red-500/30 flex items-center justify-center backdrop-blur-sm"
                                >
                                    <span className="text-4xl">âŒ</span>
                                </motion.div>
                            )}
                        </>
                    )}
                </div>
            </CardBody>

            <CardFooter className="justify-between px-4 pb-4 pt-0">
                <Button size="sm" variant="flat" color="warning" onPress={undo} isDisabled={clicks.length === 0 || verifyStatus !== 'idle'}>
                    æ’¤é”€
                </Button>

                <div className="text-xs text-gray-500">{message}</div>

                <div className="flex gap-2">
                    <Button size="sm" variant="light" onPress={fetchCaptcha}>åˆ·æ–°</Button>
                    <Button
                        size="sm"
                        color="primary"
                        isLoading={verifyStatus === 'verifying'}
                        onPress={verify}
                    >
                        éªŒè¯
                    </Button>
                </div>
            </CardFooter>
        </Card>
    );
}
==========================================================================

============================src/pages/CaptchaDebug.tsx============================
import { useState, useEffect } from 'react';
import CaptchaWidget from '@/components/CaptchaWidget';
import { Listbox, ListboxItem, ScrollShadow } from "@heroui/react";

export default function CaptchaDebugPage() {
    const [plugins, setPlugins] = useState<string[]>([]);
    const [selectedSlug, setSelectedSlug] = useState<string>('');

    // åŠ è½½æ’ä»¶åˆ—è¡¨
    useEffect(() => {
        fetch('/api/captcha/list')
            .then(res => res.json())
            .then(data => {
                setPlugins(data);
                if(data.length > 0) setSelectedSlug(data[0]);
            })
            .catch(err => console.error("Dev mode plugin list failed", err));
    }, []);

    return (
        <div className="flex h-full w-full bg-[url('https://w.wallhaven.cc/full/qz/wallhaven-qz3kwd.jpg')] bg-cover bg-center">
            {/* å·¦ä¾§æ ï¼šæ’ä»¶é€‰æ‹© */}
            <div className="w-64 bg-background/80 backdrop-blur-xl border-r border-divider flex flex-col">
                <div className="p-4 font-bold text-xl border-b border-divider">
                    ğŸ§ª å®éªŒå®¤
                </div>
                <ScrollShadow className="flex-1 p-2">
                    <Listbox
                        aria-label="Plugins"
                        onAction={(key) => setSelectedSlug(key as string)}
                        selectionMode="single"
                        selectedKeys={[selectedSlug]}
                        variant="flat"
                        color="primary"
                    >
                        {plugins.map(slug => (
                            <ListboxItem key={slug} description={`Slug: ${slug}`}>
                                {slug.toUpperCase()} æ’ä»¶
                            </ListboxItem>
                        ))}
                    </Listbox>
                </ScrollShadow>
                <div className="p-4 text-xs text-gray-500">
                    Dev Mode Enabled
                </div>
            </div>

            {/* å³ä¾§ï¼šå±•ç¤ºåŒºåŸŸ */}
            <div className="flex-1 flex flex-col items-center justify-center relative">
                <div className="absolute inset-0 bg-black/20 pointer-events-none" /> {/* é®ç½©å±‚å¢åŠ å¯¹æ¯”åº¦ */}

                <div className="z-10 flex flex-col gap-4 items-center">
                    <h2 className="text-3xl font-bold text-white drop-shadow-md">
                        {selectedSlug.toUpperCase()} CAPTCHA
                    </h2>

                    {/* è¿™é‡Œçš„ key å¾ˆé‡è¦ï¼Œåˆ‡æ¢ slug æ—¶å¼ºåˆ¶é‡æ–°æ¸²æŸ“ç»„ä»¶ */}
                    {selectedSlug && (
                        <CaptchaWidget
                            key={selectedSlug}
                            slug={selectedSlug}
                            width={500}
                            height={400}
                            className="w-[540px]" // ç¨å¾®æ¯”å›¾ç‰‡å®½ä¸€ç‚¹
                        />
                    )}
                </div>
            </div>
        </div>
    );
}
==========================================================================

============================src/utils/crypto.ts============================
import CryptoJS from 'crypto-js';

// todo  ç¯å¢ƒå˜é‡ï¼ï¼ï¼
const AES_KEY = CryptoJS.enc.Utf8.parse("1234567890987654");

/**
 * AES-CBC åŠ å¯† (å¯¹åº” Python: aes_cbc_encrypt)
 * é€»è¾‘: ç”Ÿæˆéšæœº IV -> åŠ å¯† -> æ‹¼æ¥ IV + å¯†æ–‡ -> Base64
 */
export const encryptPayload = (data: object): string => {
    const jsonStr = JSON.stringify(data);
    const iv = CryptoJS.lib.WordArray.random(16);

    const encrypted = CryptoJS.AES.encrypt(jsonStr, AES_KEY, {
        iv: iv,
        mode: CryptoJS.mode.CBC,
        padding: CryptoJS.pad.Pkcs7
    });
    
    const combined = iv.clone().concat(encrypted.ciphertext);
    return CryptoJS.enc.Base64.stringify(combined);
};

/**
 * AES-CBC è§£å¯† (å¯¹åº” Python: aes_cbc_decrypt)
 * é€»è¾‘: Base64è§£ç  -> æå–å‰16å­—èŠ‚ä¸º IV -> è§£å¯†
 */
export const decryptPayload = (base64Str: string): any => {
    try {
        const combined = CryptoJS.enc.Base64.parse(base64Str);
        const iv = CryptoJS.lib.WordArray.create(combined.words.slice(0, 4));
        const ciphertext = CryptoJS.lib.WordArray.create(combined.words.slice(4), combined.sigBytes - 16);

        const decrypted = CryptoJS.AES.decrypt(
            { ciphertext: ciphertext } as any,
            AES_KEY,
            {
                iv: iv,
                mode: CryptoJS.mode.CBC,
                padding: CryptoJS.pad.Pkcs7
            }
        );

        return JSON.parse(decrypted.toString(CryptoJS.enc.Utf8));
    } catch (e) {
        console.error("Decryption failed", e);
        return null;
    }
};
==========================================================================

